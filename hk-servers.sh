#!/bin/dash

. $(dirname $(readlink -f $0))/basic_functions.sh
. $THIS_DIR/setup_routines.sh

IFCE=enp1s0
NMSK=255.255.255.0
GWAT=10.0.0.254
index=1

main () 
{
	check_sudo
	check_apt nmap

	if [ "$1" = 'kill' ]; then
		pkill ncat
		exit 0
	fi

	if [ "$1" = 'del' ]; then
		while true; do
			ifconfig $IFCE:$index down
			index=$(expr $index + 1)
		done
		exit 0
	fi

	IFS='
'
	set -- $SRVS; while [ "$1" != '' ]; do
		local hostport="$1"; shift
		local host=$(echo "$hostport" | cut -f1)
		local port=$(echo "$hostport" | cut -f2)

		if add_ip $index $host; then
			index=$(expr $index + 1)
		fi
		ncat -l $host $port -k -c 'xargs -n1 echo' &
	done
}

add_ip()
{
	local index=$1
	local ip=$2
	local mask=$3

	if [ "X$mask" = 'X' ]; then
		mask=$NMSK
	fi
	
	if ifconfig | grep -iq "inet $ip"; then
		log_y "$ip has added"
		return 1
	fi
	#ifconfig $IFCE:$index "$ip" netmask $mask broadcast 10.0.0.255 up
	ip addr add "$ip/24" dev $IFCE
	return 0
}


SRVS='
10.0.0.20	80
10.0.0.20	1120
10.0.0.20	8989
10.0.0.21	22
10.0.0.22	3389
10.0.0.29	89
10.0.0.29	90
10.0.0.29	189
10.0.0.29	190
10.0.0.29	192
10.0.0.29	9100
10.0.0.29	20052
10.0.0.30	20053
10.0.0.31	80
10.0.0.31	443
10.0.0.33	20059
10.0.0.34	20055
10.0.0.35	20056
10.0.0.37	20058
10.0.0.38	20054
10.0.0.40	443
10.0.0.40	10001
10.0.0.40	10002	
10.0.0.40	20051
10.0.0.40	30050
10.0.0.50	443
10.0.0.50	3690
10.0.0.61	22
10.0.0.61	90
10.0.0.61	92
10.0.0.61	190
10.0.0.80	189
10.0.0.80	190
10.0.0.80	192
10.0.0.80	9100
10.0.0.80	9200
10.0.0.80	30050
10.0.0.82	81
10.0.0.83	443
10.0.0.91	80
10.0.0.110	20050
10.0.0.110	30050
10.0.0.111	189
10.0.0.111	190
10.0.0.111	192
10.0.0.111	9100
10.0.0.111	9200
10.0.0.111	20051
10.0.0.112	20052
10.0.0.115	20053
10.0.0.116	20054
10.0.0.117	20055
10.0.0.118	20056
10.0.0.119	20057
10.0.0.150	20050
10.0.0.150	30050
10.0.0.151	189
10.0.0.151	190
10.0.0.151	192
10.0.0.151	9100
10.0.0.151	20051
10.0.0.152	20052
10.0.0.154	20053
10.0.0.155	20054
10.0.0.157	20055
10.0.0.159	20057
10.0.0.160	30050
10.0.0.188	443
10.0.0.200	443
10.0.0.200	30050
10.0.0.201	189
10.0.0.201	190
10.0.0.201	192
10.0.0.201	9100
10.0.0.244	443
10.0.0.244	30050
10.0.0.245	20
10.0.0.245	21
10.0.0.245	22
10.0.0.245	80
10.0.0.245	89
10.0.0.245	90
10.0.0.245	92
10.0.0.245	190
10.0.0.245	9100
10.0.0.246	22
10.0.0.246	443
10.0.0.247	22
10.0.0.249	443
10.0.0.249	3690
10.0.0.250	22
10.0.0.250	80
10.0.0.250	6379
10.0.0.250	8080
10.0.0.250	9100
10.0.0.250	9200
10.0.0.251	80
10.0.0.251	443
10.0.0.251	3306
10.0.0.252	22
10.0.0.252	80
10.0.0.253	8080
10.0.0.253	22222
10.0.0.253	25565
'

maintain()
{
	check_update
	[ "$1" = 'help' ] && show_help_exit
}

show_help_exit()
{
	cat << EOL

EOL
	exit 0
}

maintain "$@"; main "$@"; exit $?
